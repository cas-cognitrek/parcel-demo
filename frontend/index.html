<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Cytoscape -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>

  <script>
    window.API_BASE = window.API_BASE || "";  // set in config.js if backend is live
  </script>

  <style>
    :root{ --panel-w:420px; --border:#cfd6df; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,sans-serif; color:#182230; }
    .app{ display:grid;
          grid-template-columns:minmax(0,1fr) var(--panel-w);
          grid-template-rows:60vh 1fr; min-height:100vh; }
    .mapwrap{ grid-column:1; grid-row:1; position:relative; }
    #map{ position:absolute; inset:0; }
    .graphwrap{ grid-column:1; grid-row:2; border-top:1px solid var(--border);}
    #graph{ width:100%; height:100%; min-height:24vh; }
    .panel{ grid-column:2; grid-row:1/span 2;
            border-left:1px solid var(--border); overflow:auto;
            padding:16px; background:#fff; }
    .toolbar{ position:absolute; top:10px; left:10px; z-index:500;
              display:flex; gap:8px; align-items:center;
              background:#fff; border:1px solid var(--border);
              border-radius:8px; padding:6px 8px; }
    .toolbar label{ font-size:12px; color:#506173; }
    select,button{ font:inherit; border:1px solid var(--border);
                   border-radius:6px; padding:6px 8px; }
    .panel h2{ margin:0 0 8px; font-size:18px; }
    .muted{ color:#6b7a90; font-size:12px; }
    .row{ padding:10px 0; border-bottom:1px solid var(--border); }
    .row .lbl{ font-weight:600; margin-bottom:6px; }
    .empty{ color:#9aa6b2; }
    .legend{ display:flex; gap:12px; flex-wrap:wrap; font-size:12px; margin-top:8px;}
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
  </style>
</head>
<body>

<div class="app">
  <div class="mapwrap">
    <div class="toolbar">
      <label for="parcelSelect">Jump:</label>
      <select id="parcelSelect"><option value="">— choose —</option></select>
      <span id="modeLabel" class="muted"></span>
    </div>
    <div id="map"></div>
  </div>

  <div class="graphwrap"><div id="graph"></div></div>

  <aside class="panel">
    <h2>Parcel</h2>
    <div class="muted">Source: <span id="sourceVal">—</span></div>

    <div class="row"><div class="lbl">Parcel:</div><div id="p-id">—</div></div>
    <div class="row"><div class="lbl">Legal:</div><div id="p-legal">(no details)</div></div>
    <div class="row"><div class="lbl">Title:</div><div id="p-title">—</div></div>
    <div class="row"><div class="lbl">Owners:</div><div id="p-owners">—</div></div>
    <div class="row"><div class="lbl">RRR:</div><div id="p-rrr">—</div></div>
    <div class="row"><div class="lbl">Zoning:</div><div id="p-zoning">—</div></div>
    <div class="row"><div class="lbl">Survey Plan:</div><div id="p-plan">—</div></div>
    <div class="row"><div class="lbl">Assessment:</div><div id="p-assess">—</div></div>

    <div class="row">
      <div class="lbl">Graph Legend</div>
      <div class="legend">
        <span><span class="dot" style="background:#e74c3c"></span>Parcel</span>
        <span><span class="dot" style="background:#2ecc71"></span>Title</span>
        <span><span class="dot" style="background:#8e7cf3"></span>Owner</span>
        <span><span class="dot" style="background:#f39c12"></span>RRR</span>
        <span><span class="dot" style="background:#f6c14b"></span>Zoning</span>
        <span><span class="dot" style="background:#58c4dc"></span>Plan</span>
        <span><span class="dot" style="background:#3498db"></span>Assessment</span>
      </div>
    </div>
  </aside>
</div>

<script>
const GEOJSON_URL = './synthetic_parcels.geojson';
const USING_API = (window.API_BASE && window.API_BASE.trim() !== '');
document.getElementById('modeLabel').textContent = USING_API ? 'Live API' : 'Local JSON';
document.getElementById('sourceVal').textContent = USING_API ? window.API_BASE : 'local files';

const COLORS = {
  Parcel:'#e74c3c', Title:'#2ecc71', Owner:'#8e7cf3',
  RRR:'#f39c12', Zoning:'#f6c14b', Plan:'#58c4dc',
  Assessment:'#3498db', Default:'#95a5a6'
};

// map
const map = L.map('map').setView([49.246,-123.116],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let featureIndex={}, currentId=null;

function styleParcel(){ return {color:'#2a78ff',weight:1.2,fillColor:'#3987ff',fillOpacity:0.15}; }
function styleSelected(){ return {color:'#ff3b30',weight:2,fillColor:'#ff6b5a',fillOpacity:0.25}; }

function selectParcel(id){
  if(!id||!featureIndex[id])return;
  if(currentId&&featureIndex[currentId]) featureIndex[currentId].setStyle(styleParcel());
  currentId=id;
  featureIndex[id].setStyle(styleSelected());
  map.panTo(featureIndex[id].getBounds().getCenter());
  loadDetails(id);
}

fetch(GEOJSON_URL).then(r=>r.json()).then(geo=>{
  L.geoJSON(geo,{style:styleParcel,onEachFeature:(f,lyr)=>{
    const id=f.properties?.parcelid||f.properties?.parcelId||f.properties?.id;
    featureIndex[id]=lyr;
    lyr.bindTooltip(id); lyr.on('click',()=>selectParcel(id));
  }}).addTo(map);
  const sel=document.getElementById('parcelSelect');
  Object.keys(featureIndex).sort().forEach(id=>{
    const o=document.createElement('option'); o.value=id;o.textContent=id; sel.appendChild(o);
  });
  sel.onchange=e=>selectParcel(e.target.value);
});

// panel
function setText(id,text){document.getElementById(id).textContent=text||'—';}

function loadDetails(id){
  if(USING_API){
    fetch(`${API_BASE}/api/v1/parcels/${encodeURIComponent(id)}`)
      .then(r=>r.json()).then(d=>{
        setText('p-id', d.parcelId);
        setText('p-legal', d.parcel?.properties?.legaldescription);
        setText('p-title', d.title?.properties?.id||d.title?.properties?.name);
        setText('p-owners', (d.owners||[]).map(o=>o.properties?.name).join(', '));
        setText('p-rrr', (d.rrrs||[]).map(r=>r.properties?.type).join(', '));
        setText('p-zoning', (d.zonings||[]).map(z=>z.properties?.code).join(', '));
        setText('p-plan', d.surveyPlan?.properties?.name||d.surveyPlan?.properties?.id);
        setText('p-assess', d.assessment?.properties?.year||d.assessment?.properties?.id);
      }).catch(()=>{setText('p-id',id);});
    renderGraph(id);
  }else{
    setText('p-id',id);
  }
}

// graph
let cy=cytoscape({container:document.getElementById('graph'),elements:[],style:[
 {selector:'node',style:{'background-color':ele=>COLORS[ele.data('label')]||COLORS.Default,
                         'label':'data(id)','font-size':10,'color':'#111'}},
 {selector:'edge',style:{'line-color':'#aaa','target-arrow-shape':'triangle','target-arrow-color':'#aaa',
                         'curve-style':'bezier','label':'data(type)','font-size':9}}]});

function renderGraph(id){
  fetch(`${API_BASE}/api/v1/graph/parcel/${encodeURIComponent(id)}`)
    .then(r=>r.json()).then(g=>{
      cy.elements().remove();
      const nodes=(g.nodes||[]).map(n=>({data:{id:n.id,label:n.label||'Default'}}));
      const edges=(g.links||[]).map(e=>({data:{id:`${e.source}->${e.target}`,source:e.source,target:e.target,type:e.type}}));
      cy.add(nodes); cy.add(edges);
      cy.layout({name:'cose',animate:false}).run(); cy.fit();
    });
}
</script>
</body>
</html>
