<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parcel Demo</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Cytoscape + layout plugin -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/cytoscape-cose-bilkent/cytoscape-cose-bilkent.js"></script>
  <script>
    // register the layout plugin
    if (window.cytoscape && window.cytoscapeCoseBilkent) {
      cytoscape.use(cytoscapeCoseBilkent);
    }
  </script>

  <!-- App config (defines window.API_BASE) -->
  <script src="config.js"></script>

  <style>
    :root{
      --border:#c8cdd6;
      --panel-w: 420px;        /* parcel detail panel width */
      --graph-h: 28vh;         /* graph panel height */
      --toolbar-h: 46px;
    }
    *{box-sizing:border-box}
    body,html{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:#1f2937;}

    /* Layout */
    .app {
      display:grid;
      grid-template-columns: 1fr var(--panel-w);
      grid-template-rows: calc(100vh - var(--graph-h)) var(--graph-h);
      height:100vh;
      width:100vw;
    }
    #map { border-right:1px solid var(--border); }
    #map, #graph { width:100%; height:100%; }

    /* Right panel */
    .panel {
      grid-row: 1 / span 2;
      border-left:1px solid var(--border);
      display:flex;
      flex-direction:column;
      overflow:auto;
      background:#fff;
    }
    .panel-header{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      font-weight:600;
      font-size:18px;
    }
    .panel-body { padding:10px 16px 20px; }
    .section { padding:10px 0; border-bottom:1px solid var(--border); }
    .section h4 { margin:0 0 6px; font-size:14px; color:#374151; }
    .muted { color:#6b7280; }
    .value { font-weight:600; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; padding-top:8px; font-size:12px; align-items:center;}
    .legend .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:4px; }
    .fine { font-size:12px; color:#6b7280; padding-top:8px; }

    /* Dropdown toolbar (top-left over the map) */
    .toolbar {
      position:absolute; z-index:500; top:10px; left:10px;
      background:#fff; border:1px solid var(--border); border-radius:8px;
      padding:6px; box-shadow:0 4px 16px rgba(0,0,0,.08);
      display:flex; gap:8px; align-items:center;
    }
    .toolbar label{ font-size:12px; color:#4b5563; margin-right:4px;}
    .toolbar select{ height:32px; min-width:220px; padding:4px 8px; }

    /* Graph area divider line */
    .divider-h { grid-column: 1 / span 1; height:1px; background:var(--border); }

    /* Graph container */
    #graph { background:#fff; }

    /* Leaflet popup look a little cleaner */
    .leaflet-popup-content { margin:8px 12px; }
  </style>
</head>

<body>
  <div class="app">
    <!-- Map cell -->
    <div style="position:relative">
      <div class="toolbar">
        <label for="parcelSelect">Jump to parcel:</label>
        <select id="parcelSelect">
          <option value="">— choose —</option>
        </select>
        <span id="modeBadge" class="muted" style="margin-left:8px;"></span>
      </div>
      <div id="map"></div>
    </div>

    <!-- Right parcel info panel (spans both rows) -->
    <aside class="panel">
      <div class="panel-header">Parcel</div>
      <div class="panel-body">
        <div class="section">
          <div class="muted">Source: <span id="srcLabel">—</span></div>
        </div>

        <div class="section">
          <h4>Parcel:</h4>
          <div class="value" id="v-parcel">—</div>
        </div>

        <div class="section">
          <h4>Legal:</h4>
          <div id="v-legal" class="muted">(no details)</div>
        </div>

        <div class="section">
          <h4>Title</h4>
          <div id="v-title">—</div>
        </div>

        <div class="section">
          <h4>Owner(s)</h4>
          <div id="v-owners">—</div>
        </div>

        <div class="section">
          <h4>RRR</h4>
          <div id="v-rrr">—</div>
        </div>

        <div class="section">
          <h4>Zoning</h4>
          <div id="v-zoning">—</div>
        </div>

        <div class="section">
          <h4>Survey Plan</h4>
          <div id="v-plan">—</div>
        </div>

        <div class="section">
          <h4>Assessment</h4>
          <div id="v-assessment">—</div>
        </div>

        <div class="section">
          <h4>Graph Legend</h4>
          <div class="legend">
            <span><span class="dot" style="background:#ef4444"></span>Parcel</span>
            <span><span class="dot" style="background:#60a5fa"></span>Plan</span>
            <span><span class="dot" style="background:#f59e0b"></span>Zoning</span>
            <span><span class="dot" style="background:#10b981"></span>Title</span>
            <span><span class="dot" style="background:#8b5cf6"></span>Owner</span>
            <span><span class="dot" style="background:#f97316"></span>RRR</span>
            <span><span class="dot" style="background:#3b82f6"></span>Assessment</span>
          </div>
        </div>

        <div class="fine">Tip: pick a parcel on the map or via the dropdown.</div>
      </div>
    </aside>

    <!-- horizontal divider -->
    <div class="divider-h"></div>

    <!-- Graph cell -->
    <div id="graph"></div>
  </div>

  <script>
    /**********************
     * CONFIG & CONSTANTS *
     **********************/
    const API_BASE = (typeof window.API_BASE === 'string') ? window.API_BASE.trim() : '';
    const USING_API = API_BASE.length > 0;

    // Color palette for graph nodes
    const NODE_COLORS = {
      Parcel: '#ef4444',
      Title: '#10b981',
      Owner: '#8b5cf6',
      RRR: '#f97316',
      Zoning: '#f59e0b',
      Plan: '#60a5fa',
      Assessment: '#3b82f6',
      default: '#9ca3af'
    };

    // Map & layers
    let map, parcelLayer;
    let parcelsGeoJSON = null;

    // Cytoscape instance
    let cy = null;

    // UI refs
    const ddl = document.getElementById('parcelSelect');
    const modeBadge = document.getElementById('modeBadge');
    const srcLabel = document.getElementById('srcLabel');

    // Right panel fields
    const fields = {
      parcel: document.getElementById('v-parcel'),
      legal: document.getElementById('v-legal'),
      title: document.getElementById('v-title'),
      owners: document.getElementById('v-owners'),
      rrr: document.getElementById('v-rrr'),
      zoning: document.getElementById('v-zoning'),
      plan: document.getElementById('v-plan'),
      assessment: document.getElementById('v-assessment')
    };

    /**********************
     * INIT
     **********************/
    modeBadge.textContent = USING_API ? 'Mode: Live API' : 'Mode: Local JSON';
    srcLabel.textContent = USING_API ? new URL(API_BASE).host : 'Local files';

    initMap();
    initGraph();
    loadParcels();

    /**********************
     * MAP
     **********************/
    function initMap(){
      map = L.map('map', { zoomControl: true }).setView([49.246, -123.116], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    }

    async function loadParcels(){
      try{
        // Always load GeoJSON locally from the frontend bundle
        const res = await fetch('./synthetic_parcels.geojson', { cache: 'no-cache' });
        if(!res.ok) throw new Error(`GeoJSON HTTP ${res.status}`);
        parcelsGeoJSON = await res.json();

        // populate dropdown
        ddl.innerHTML = '<option value="">— choose —</option>';
        parcelsGeoJSON.features.forEach(f=>{
          const id = (f.properties && (f.properties.parcelid || f.properties.PARCELID)) || 'unknown';
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = id;
          ddl.appendChild(opt);
        });

        // add polygons
        parcelLayer = L.geoJSON(parcelsGeoJSON, {
          style: {
            color: '#2563eb',
            weight: 1.25,
            fillColor: '#93c5fd',
            fillOpacity: 0.25
          },
          onEachFeature: (feature, layer) => {
            const pid = feature.properties?.parcelid || feature.properties?.PARCELID || 'unknown';
            layer.bindTooltip(pid, { sticky: true });

            // NOTE: clicking DOES NOT change map zoom – we keep the current view.
            layer.on('click', () => {
              ddl.value = pid;
              handleParcelChosen(pid);
            });
          }
        }).addTo(map);

        // fit once to parcels
        try{
          map.fitBounds(parcelLayer.getBounds(), { padding:[20,20] });
        }catch(_e){/* ignore if empty */}
      }catch(err){
        console.error('Failed to load synthetic_parcels.geojson', err);
        alert('Could not load synthetic_parcels.geojson. Make sure the file is deployed to your frontend root.');
      }
    }

    ddl.addEventListener('change', (e)=>{
      const id = e.target.value || '';
      if(!id) return;
      handleParcelChosen(id);
    });

    /**********************
     * PARCEL → PANEL + GRAPH
     **********************/
    async function handleParcelChosen(parcelId){
      // Update panel quick
      fields.parcel.textContent = parcelId;
      fields.legal.textContent = '(no details)';
      fields.title.textContent = '—';
      fields.owners.textContent = '—';
      fields.rrr.textContent = '—';
      fields.zoning.textContent = '—';
      fields.plan.textContent = '—';
      fields.assessment.textContent = '—';

      if(USING_API){
        // fetch parcel details
        try{
          const res = await fetch(`${API_BASE}/api/v1/parcels/${encodeURIComponent(parcelId)}`, { cache:'no-cache' });
          if(res.ok){
            const data = await res.json();
            applyParcelDetailsToPanel(data);
          }else{
            console.warn('Parcel API non-200', res.status);
          }
        }catch(err){
          console.warn('Parcel API error', err);
        }

        // fetch graph
        try{
          const r = await fetch(`${API_BASE}/api/v1/graph/parcel/${encodeURIComponent(parcelId)}`, { cache:'no-cache' });
          if(r.ok){
            const g = await r.json();
            drawGraph(g);
          }else{
            console.warn('Graph API non-200', r.status);
            drawGraph({ nodes:[], links:[] });
          }
        }catch(err){
          console.warn('Graph API error', err);
          drawGraph({ nodes:[], links:[] });
        }
      }else{
        // Local mode: draw a tiny demo graph around the parcel
        drawGraph(localGraphStub(parcelId));
      }
    }

    function applyParcelDetailsToPanel(payload){
      // payload structure from your backend (as previously discussed):
      // { parcel:{...}, title:{...}, owners:[...], rrrs:[...], zonings:[...], plans:[...], assessments:[...] }
      try{
        if(payload?.parcel){
          fields.parcel.textContent = payload.parcel.parcelid || payload.parcel.id || fields.parcel.textContent;
          fields.legal.textContent  = payload.parcel.legalDescription || '(no details)';
        }
        fields.title.textContent     = payload?.title?.id || '—';
        fields.owners.textContent    = (payload?.owners||[]).map(o=>o.name || o.id).join(', ') || '—';
        fields.rrr.textContent       = (payload?.rrrs||[]).map(r=>r.type || r.id).join(', ') || '—';
        fields.zoning.textContent    = (payload?.zonings||[]).map(z=>z.id || z.name).join(', ') || '—';
        fields.plan.textContent      = (payload?.plans||[]).map(p=>p.id || p.name).join(', ') || '—';
        fields.assessment.textContent= (payload?.assessments||[]).map(a=>a.id || a.name || a.roll || '').join(', ') || '—';
      }catch(e){
        console.warn('Panel map failed', e);
      }
    }

    /**********************
     * GRAPH
     **********************/
    function initGraph(){
      cy = cytoscape({
        container: document.getElementById('graph'),
        boxSelectionEnabled: false,
        wheelSensitivity: 0.25,
        style: [
          {
            selector: 'node',
            style: {
              'background-color': ele => NODE_COLORS[ele.data('label')] || NODE_COLORS.default,
              'label': ele => ele.data('short') || ele.data('name') || ele.data('id'),
              'color': '#111827',
              'font-size': 10,
              'text-valign': 'center',
              'text-halign': 'center',
              'width': 18,             /* small nodes as requested */
              'height': 18
            }
          },
          {
            selector: 'edge',
            style: {
              'curve-style': 'bezier',
              'line-color': '#cbd5e1',
              'width': 1.5,
              'target-arrow-color': '#cbd5e1',
              'target-arrow-shape': 'triangle',
              'arrow-scale': 0.8,
              'label': ele => ele.data('type') || '',
              'font-size': 9,
              'text-background-color': '#ffffff',
              'text-background-opacity': 0.8,
              'text-background-padding': 1
            }
          }
        ]
      });
    }

    function drawGraph(graph){
      if(!cy){ initGraph(); }
      cy.elements().remove();

      // Expect { nodes:[{id,label,name}], links:[{source,target,type}] }
      const nodes = (graph.nodes||[]).map(n => ({
        group:'nodes',
        data: {
          id: n.id || n.key || n.name,
          name: n.name || n.id,
          short: shorten(n.name || n.id),
          label: n.label || n.type || 'default'
        }
      }));

      const edges = (graph.links||[]).map(e => ({
        group:'edges',
        data: {
          id: e.id || `${e.source}->${e.target}:${e.type||''}:${Math.random().toString(36).slice(2,7)}`,
          source: e.source,
          target: e.target,
          type: e.type || ''
        }
      }));

      cy.add(nodes);
      cy.add(edges);

      // Use the cose-bilkent layout (now available)
      cy.layout({
        name: 'cose-bilkent',
        animate: false,
        randomize: true,
        nodeRepulsion: 4500,
        idealEdgeLength: 80,
        edgeElasticity: 0.15
      }).run();

      if(cy.nodes().length){
        cy.fit(cy.elements(), 20);
      }
    }

    function shorten(s, n=16){
      if(!s) return '';
      return s.length>n ? s.slice(0,n-2)+'…' : s;
    }

    function localGraphStub(parcelId){
      // Small synthetic star graph in local mode
      return {
        nodes: [
          { id: `P:${parcelId}`, name: parcelId, label:'Parcel' },
          { id: `T-${parcelId.slice(-3)}`, name:'Title', label:'Title' },
          { id: `O-${parcelId.slice(-2)}`, name:'Owner A', label:'Owner' },
          { id: `Z-${parcelId.slice(-3)}`, name:'Z-6001', label:'Zoning' },
          { id: `R-${parcelId.slice(-2)}`, name:'Right of Way', label:'RRR' },
          { id: `A-${parcelId.slice(-3)}`, name:'A-5001', label:'Assessment' }
        ],
        links: [
          { source:`P:${parcelId}`, target:`T-${parcelId.slice(-3)}`, type:'HAS_TITLE' },
          { source:`P:${parcelId}`, target:`O-${parcelId.slice(-2)}`, type:'OWNED_BY' },
          { source:`P:${parcelId}`, target:`Z-${parcelId.slice(-3)}`, type:'HAS_ZONING' },
          { source:`P:${parcelId}`, target:`R-${parcelId.slice(-2)}`, type:'HAS_RRR' },
          { source:`P:${parcelId}`, target:`A-${parcelId.slice(-3)}`, type:'HAS_ASSESSMENT' }
        ]
      };
    }
  </script>
</body>
</html>
