<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parcel Demo — BC Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Cytoscape (embedded graph) -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>

  <style>
    :root{
      --bg:#fff;
      --ink:#1b1f24;
      --muted:#6b7280;
      --bd:#e5e7eb;
      --focus:#2563eb;
      --chip:#eef2ff;
      --chipbd:#c7d2fe;
      --shadow:0 10px 25px rgba(0,0,0,.08);
    }

    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
    #map{position:absolute;inset:0}

    /* Toolbar */
    .toolbar{
      position:absolute;top:12px;left:12px;z-index:1000;display:flex;gap:8px;flex-wrap:wrap;
      background:var(--bg);border:1px solid var(--bd);border-radius:12px;padding:10px;box-shadow:var(--shadow)
    }
    .toolbar label{font-weight:700;margin-right:4px}
    .toolbar select,.toolbar button{
      padding:8px 10px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer
    }
    .toolbar button.primary{background:var(--focus);color:#fff;border-color:var(--focus)}
    .toolbar .badge{background:var(--chip);border:1px solid var(--chipbd);border-radius:10px;padding:8px 10px;font-size:12px}

    /* Sidebar */
    .sidebar{
      position:absolute;top:12px;right:12px;z-index:1000;width:360px;max-height:calc(100% - 24px);
      background:var(--bg);border:1px solid var(--bd);border-radius:12px;box-shadow:var(--shadow);display:flex;flex-direction:column
    }
    .sidebar-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--bd)}
    .sidebar-header h3{margin:0;font-size:16px}
    .sidebar-body{overflow:auto;padding:12px 14px}
    .row{margin:10px 0}
    .row h4{margin:0 0 6px 0;font-size:14px}
    .chips .chip{display:inline-block;margin:3px 6px 0 0;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--chipbd);font-size:12px}
    .kv{font-size:14px;color:var(--muted)}
    .kv b{color:var(--ink)}
    .collapse-btn{border:none;background:transparent;cursor:pointer;font-size:18px}

    /* Legend */
    .legend{
      position:absolute;left:12px;bottom:12px;z-index:1000;background:var(--bg);border:1px solid var(--bd);
      border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);font-size:13px;color:var(--muted)
    }
    .legend .swatch{display:inline-block;width:12px;height:12px;background:#1f78b4;border:2px solid #1f78b4;margin-right:6px;border-radius:2px}
    .legend .swatch.hi{background:#d81b60;border-color:#d81b60}

    /* Graph panel */
    #graph{
      position:absolute;right:12px;bottom:12px;z-index:999;width:420px;height:300px;background:#fff;border:1px solid var(--bd);
      border-radius:12px;box-shadow:var(--shadow);overflow:hidden
    }

    /* Popup tweaks */
    .leaflet-popup-content{margin:10px 14px}
  </style>
</head>
<body>
  <!-- Toolbar -->
  <div class="toolbar">
    <label for="parcelSelect">Jump to parcel:</label>
    <select id="parcelSelect"><option value="">— choose —</option></select>

    <label for="basemap">Basemap:</label>
    <select id="basemap">
      <option value="osm">OSM</option>
      <option value="topo">Topo</option>
      <option value="light">Light</option>
    </select>

    <button id="resetBtn">Reset view</button>
    <span id="modeBadge" class="badge">Mode: Local JSON</span>
    <button id="toggleSidebar" class="primary">Toggle details</button>
  </div>

  <!-- Sidebar (collapsible) -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3 id="sbTitle">No parcel selected</h3>
      <button class="collapse-btn" id="sbClose" title="Hide">×</button>
    </div>
    <div class="sidebar-body" id="sbBody">
      <div class="kv">Choose a parcel on the map or from the dropdown.</div>
    </div>
  </aside>

  <!-- Legend -->
  <div class="legend">
    <div><b>Demo parcels (BC)</b></div>
    <div style="margin-top:4px"><span class="swatch"></span>parcel&nbsp;&nbsp;&nbsp;<span class="swatch hi"></span>selected</div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Embedded Neo4j graph -->
  <div id="graph"></div>

  <!-- Config (sets window.API_BASE) -->
  <script src="config.js"></script>

  <script>
  // =============== 0) Globals & UI grabs ===================
  const $select    = document.getElementById('parcelSelect');
  const $basemap   = document.getElementById('basemap');
  const $resetBtn  = document.getElementById('resetBtn');
  const $modeBadge = document.getElementById('modeBadge');
  const $sidebar   = document.getElementById('sidebar');
  const $sbTitle   = document.getElementById('sbTitle');
  const $sbBody    = document.getElementById('sbBody');
  const $sbClose   = document.getElementById('sbClose');
  const $toggleSidebar = document.getElementById('toggleSidebar');

  const useAPI = !!window.API_BASE; // Live if API_BASE non-empty
  $modeBadge.textContent = useAPI ? "Mode: Live API" : "Mode: Local JSON";

  // =============== 1) Map & basemaps =======================
  const basemaps = {
    osm:  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}),
    topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17,attribution:'© OpenTopoMap'}),
    light:L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'© Stadia Maps, © OpenMapTiles, © OpenStreetMap'})
  };
  const map = L.map('map',{center:[49.25,-123.12],zoom:12,layers:[basemaps.osm]});

  $basemap.addEventListener('change', ()=>{
    const key = $basemap.value;
    Object.values(basemaps).forEach(ly=>map.removeLayer(ly));
    basemaps[key].addTo(map);
  });
  $resetBtn.addEventListener('click',()=> fitAll());

  // =============== 2) Inline GeoJSON (9 parcels, BC) =======
  (function buildParcels(){
    const minLon = -123.20, minLat = 49.22, size = 0.010, gap = 0.002;
    const ids = ["012-345-101","012-345-102","012-345-103","012-345-104","012-345-105","012-345-106","012-345-107","012-345-108","012-345-109"];
    const feats = [];
    let n=0;
    for(let r=0;r<3;r++){
      for(let c=0;c<3;c++){
        const lon0=minLon + c*(size+gap), lat0=minLat + r*(size+gap);
        const ring=[[lon0,lat0],[lon0,lat0+size],[lon0+size,lat0+size],[lon0+size,lat0],[lon0,lat0]];
        feats.push({type:"Feature",properties:{parcelId:ids[n++]},geometry:{type:"Polygon",coordinates:[ring]}});
      }
    }
    window.PARCELS_GEOJSON = {type:"FeatureCollection",features:feats};
  })();

  // =============== 3) Layer + interactions =================
  const byParcelId = new Map();
  let geoLayer, highlighted;

  function addParcelsLayer(){
    geoLayer = L.geoJSON(window.PARCELS_GEOJSON,{
      style:{color:"#1f78b4",weight:2,fillOpacity:.15},
      onEachFeature:(f,layer)=>{
        const pid=f.properties?.parcelId;
        if(pid) byParcelId.set(pid,layer);
        layer.on('click',()=> selectParcel(pid,layer,true));
      }
    }).addTo(map);
    fitAll();
    populateDropdown();
  }

  function fitAll(){
    const b = geoLayer?.getBounds();
    if(b && b.isValid()) map.fitBounds(b.pad(0.2));
  }

  function highlight(layer){
    if(highlighted) highlighted.setStyle({color:"#1f78b4",weight:2,fillOpacity:.15});
    highlighted=layer;
    layer.setStyle({color:"#d81b60",weight:3,fillOpacity:.25});
  }

  function populateDropdown(){
    const ids=(window.PARCELS_GEOJSON?.features||[]).map(f=>f.properties.parcelId).sort();
    ids.forEach(pid=>{
      const opt=document.createElement('option'); opt.value=pid; opt.textContent=pid;
      $select.appendChild(opt);
    });
  }

  $select.addEventListener('change', ()=>{
    const pid=$select.value; if(!pid) return;
    const lyr=byParcelId.get(pid);
    if(lyr){
      map.fitBounds(lyr.getBounds().pad(0.3));
      selectParcel(pid,lyr,false);
    }
  });

  // =============== 4) Parcel details + sidebar =============
  function setSidebar(title, html){
    $sbTitle.textContent = title || "Parcel";
    $sbBody.innerHTML = html || "<div class='kv'>No details.</div>";
  }
  $sbClose.addEventListener('click', ()=> $sidebar.style.display='none');
  $toggleSidebar.addEventListener('click', ()=> {
    $sidebar.style.display = ($sidebar.style.display==='none' ? 'flex' : 'none');
  });

  function chip(txt){return `<span class="chip">${txt}</span>`;}
  function money(n){return (n==null||isNaN(n))?"—":Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});}
  function safe(v,d="—"){return (v==null||v==="")?d:v;}

  function renderDetails(view){
    const parcel   = view.parcel?.properties ? view.parcel.properties : (view.parcel||view);
    const pid      = safe(parcel?.parcelId,"Unknown");
    const legal    = safe(parcel?.legalDescription,"—");

    const titles   = view.titles || (view.title ? [view.title] : []);
    const owners   = view.owners || [];
    const rrrs     = view.rrrs || [];
    const plans    = view.plans || (view.surveyPlan ? [view.surveyPlan] : []);
    const assess   = view.assessments || (view.assessment ? [view.assessment] : []);
    const zonings  = view.zonings || (view.zoning ? [view.zoning] : []);

    const titleBadges = titles.length ? titles.map(t=>{
      const p=t.properties||t; return chip(`${safe(p.titleId,"Title")} — ${safe(p.status,"")}`);
    }).join("") : "—";
    const ownersList = owners.length ? `<ul style="margin:0;padding-left:18px">${owners.map(o=>{
      const p=o.properties||o; const s=p.share?` <small style="opacity:.7">(${p.share})</small>`:""; return `<li>${safe(p.name,"Owner")}${s}</li>`;
    }).join("")}</ul>` : "—";
    const rrrBadges  = rrrs.length ? rrrs.map(r=>{const p=r.properties||r; return chip([p.type,p.status,p.holder].filter(Boolean).join(" • "));}).join("") : "—";
    const planBadges = plans.length ? plans.map(sp=>{const p=sp.properties||sp; return chip(`${safe(p.planId,"Plan")} — ${safe(p.description,"")}`);}).join("") : "—";
    const assessBadges= assess.length ? assess.map(a=>{const p=a.properties||a; return chip(`${safe(p.year,"Year")} — ${money(p.value)}`);}).join("") : "—";
    const zoneBadges = zonings.length ? zonings.map(z=>{const p=z.properties||z; return chip(safe(p.zoneType,p.zoneId||"Zoning"));}).join("") : "—";

    return `
      <div class="row kv"><b>Parcel:</b> ${pid}</div>
      <div class="row kv"><b>Legal:</b> ${legal}</div>
      <div class="row"><h4>Title</h4><div class="chips">${titleBadges}</div></div>
      <div class="row"><h4>Owner(s)</h4>${ownersList}</div>
      <div class="row"><h4>RRR</h4><div class="chips">${rrrBadges}</div></div>
      <div class="row"><h4>Zoning</h4><div class="chips">${zoneBadges}</div></div>
      <div class="row"><h4>Survey Plan</h4><div class="chips">${planBadges}</div></div>
      <div class="row"><h4>Assessment</h4><div class="chips">${assessBadges}</div></div>
      <div class="row kv" style="opacity:.7">Source: ${useAPI?"Live API":"Local JSON"}</div>
    `;
  }

  async function selectParcel(pid, layer, pan){
    if(!pid||!layer) return;
    highlight(layer);
    if(pan){ const b=layer.getBounds(); if(b?.isValid()) map.fitBounds(b.pad(0.25)); }

    let data;
    try{
      if(useAPI){
        const r = await fetch(`${window.API_BASE}/api/v1/parcels/${encodeURIComponent(pid)}`);
        if(!r.ok) throw new Error(`API ${r.status}`);
        data = await r.json();
      }else{
        const r = await fetch('parcel_views.json'); // local demo
        const views = await r.json();
        data = views[pid] || { parcel:{parcelId:pid,legalDescription:"(demo)"} };
      }
    }catch(e){
      data = { parcel:{parcelId:pid,legalDescription:"(no details)"} };
      console.warn("Detail fetch failed", e);
    }

    // Popup + Sidebar
    layer.bindPopup(`<b>Parcel ${pid}</b><br>${(data.parcel?.properties?.legalDescription)||data.legalDescription||"—"}`).openPopup();
    setSidebar(`Parcel ${pid}`, renderDetails(data));

    // Graph
    loadParcelGraph(pid);
    // Ensure sidebar visible
    $sidebar.style.display='flex';
  }

  // =============== 5) Cytoscape mini-graph =================
  let cy;
  function initGraph(){
    cy = cytoscape({
      container: document.getElementById('graph'),
      style: [
        { selector:'node', style:{ 'label':'data(label)','text-valign':'center','font-size':10,
                                   'background-color':'#F5F7FA','border-width':2,'border-color':'#9AA1AC','color':'#1b1f24'}},
        { selector:'node[labelType = "Parcel"]',      style:{ 'background-color':'#ff6b6b','border-color':'#e35151' }},
        { selector:'node[labelType = "Title"]',       style:{ 'background-color':'#51cf66','border-color':'#37b24d' }},
        { selector:'node[labelType = "Owner"]',       style:{ 'background-color':'#4dabf7','border-color':'#228be6' }},
        { selector:'node[labelType = "RRR"]',         style:{ 'background-color':'#ffa94d','border-color':'#f08c00' }},
        { selector:'node[labelType = "SurveyPlan"]',  style:{ 'background-color':'#b197fc','border-color':'#845ef7' }},
        { selector:'node[labelType = "Assessment"]',  style:{ 'background-color':'#63e6be','border-color':'#20c997' }},
        { selector:'node[labelType = "Zoning"]',      style:{ 'background-color':'#ffd43b','border-color':'#f59f00' }},
        { selector:'edge',  style:{ 'label':'data(type)','width':2,'line-color':'#B7BEC9','target-arrow-color':'#B7BEC9',
                                    'target-arrow-shape':'triangle','curve-style':'bezier','font-size':8}}
      ],
      layout:{ name:'concentric', minNodeSpacing:40 }
    });
  }

  async function loadParcelGraph(pid){
    if(!useAPI) { cy?.elements().remove(); return; }
    try{
      const r = await fetch(`${window.API_BASE}/api/v1/graph/parcel/${encodeURIComponent(pid)}`);
      const g = await r.json();
      const nodes = (g.nodes||[]).map(n=>{
        const t=(n.labels&&n.labels[0])||'Node';
        const p=n.props||{};
        const label = t==='Parcel'     ? (p.parcelId||'Parcel')
                     : t==='Title'      ? (p.titleId||'Title')
                     : t==='Owner'      ? (p.name||'Owner')
                     : t==='RRR'        ? (p.type||'RRR')
                     : t==='SurveyPlan' ? (p.planId||'Plan')
                     : t==='Assessment' ? (String(p.year||p.assessmentId||'Assess'))
                     : t==='Zoning'     ? (p.zoneType||p.zoneId||'Zoning')
                     : t;
        return { data:{ id:n.id, label, labelType:t }};
      });
      const edges = (g.links||[]).map(e=>({ data:{ id:e.id, source:e.source, target:e.target, type:e.type }}));
      cy.elements().remove(); cy.add([...nodes,...edges]); cy.layout({name:'concentric',minNodeSpacing:40}).run(); cy.fit(undefined,30);
    }catch(e){ console.warn("Graph fetch failed",e); }
  }

  // =============== 6) Boot =================================
  addParcelsLayer();
  initGraph();
  </script>
</body>
</html>
