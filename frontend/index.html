<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Demo — BC, Canada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2tu2Tqj1bWgGvZ3Ww7x6O9KpUQ5pU9Gt6Z8Jf6Q="
    crossorigin=""
  />

  <style>
    :root{
      --panel-bg:#ffffff;
      --panel-bd:#e6e6e6;
      --shadow:0 6px 18px rgba(0,0,0,.08);
      --text:#1b1f24;
      --muted:#666;
      --pill-bg:#eef3ff;
      --pill-bd:#cfd8ff;
      --brand:#1f78b4;
    }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); }
    /* Map */
    #map { position: absolute; inset: 0; }
    /* Floating toolbar */
    #toolbar {
      position: absolute; z-index: 1000; top: 14px; left: 14px;
      background: var(--panel-bg); border: 1px solid var(--panel-bd);
      border-radius: 12px; padding: 12px; box-shadow: var(--shadow);
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    }
    #toolbar label { font-weight: 700; margin-right: 6px; }
    #parcelSelect, #modeBadge {
      padding: 8px 10px; border: 1px solid var(--panel-bd); border-radius: 10px;
      min-width: 280px; background: #fff;
    }
    #modeBadge {
      min-width: auto; background: var(--pill-bg); border-color: var(--pill-bd); font-size: 12px;
    }
    .leaflet-popup-content { margin: 10px 14px; }
    /* Legend */
    #legend {
      position: absolute; z-index: 1000; bottom: 14px; left: 14px;
      background: var(--panel-bg); border: 1px solid var(--panel-bd);
      border-radius: 12px; padding: 10px 12px; box-shadow: var(--shadow);
      font-size: 13px; color: var(--muted);
    }
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--pill-bg);border:1px solid var(--pill-bd);margin-right:6px;margin-bottom:4px;}
    /* Embedded graph panel */
    #graph {
      position:absolute; right:14px; bottom:14px; z-index:1000;
      width:420px; height:300px; background:#fff; border:1px solid var(--panel-bd);
      border-radius:12px; box-shadow:var(--shadow); overflow:hidden;
    }
  </style>
</head>
<body>

  <!-- Controls -->
  <div id="toolbar">
    <label for="parcelSelect">Jump to parcel:</label>
    <select id="parcelSelect">
      <option value="">— choose —</option>
    </select>
    <span id="modeBadge"></span>
  </div>

  <!-- Legend -->
  <div id="legend">
    <div><b>Demo parcels (BC)</b></div>
    <div style="margin-top:4px">Click a polygon or pick from the dropdown.</div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Embedded Neo4j mini-graph -->
  <div id="graph"></div>

  <!-- Config (defines window.API_BASE) -->
  <script src="config.js"></script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStbYv7vQkGx1nQ2e8lYH8k1L5l6Z8Z8aI7Q="
    crossorigin=""
  ></script>
  <!-- Cytoscape for the mini-graph -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>

  <script>
  // =========================================================
  // 1) Inline GeoJSON: 9 non-touching squares near Vancouver
  // =========================================================
  (function buildParcels(){
    const minLon = -123.20;  // west
    const minLat =  49.22;   // south
    const size   =  0.010;   // ~1.1km square
    const gap    =  0.002;   // ~200m gap (no touching)

    const ids = [
      "012-345-101","012-345-102","012-345-103",
      "012-345-104","012-345-105","012-345-106",
      "012-345-107","012-345-108","012-345-109"
    ];

    const features = [];
    let n = 0;
    for (let r=0; r<3; r++){
      for (let c=0; c<3; c++){
        const lon0 = minLon + c*(size+gap);
        const lat0 = minLat + r*(size+gap);
        const lon1 = lon0 + size;
        const lat1 = lat0 + size;
        const ring = [[lon0,lat0],[lon0,lat1],[lon1,lat1],[lon1,lat0],[lon0,lat0]];
        features.push({
          type:"Feature",
          properties:{ parcelId: ids[n++] },
          geometry:{ type:"Polygon", coordinates:[ ring ] }
        });
      }
    }

    window.PARCELS_GEOJSON = { type:"FeatureCollection", features };
  })();

  // =========================================================
  // 2) Helpers for popup rendering
  // =========================================================
  const $mode = document.getElementById('modeBadge');
  function setModeBadge(){ $mode.textContent = window.API_BASE ? "Mode: Live API" : "Mode: Local JSON"; }
  setModeBadge();

  function money(n){ if(n===null||n===undefined||isNaN(n)) return "—"; return Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
  function safe(v,d="—"){ return (v===null||v===undefined||v==="")?d:v; }
  function chip(txt){ return `<span class="chip">${txt}</span>`; }

  function renderOwners(owners=[]){
    if(!owners.length) return "—";
    return owners.map(o=>{
      const p=o.properties||o;
      const nm=safe(p.name,"Unknown");
      const sh=p.share?` <small style="opacity:.7">(${p.share})</small>`:"";
      return `<li>${nm}${sh}</li>`;
    }).join("");
  }
  function renderRRR(rrrs=[]){
    if(!rrrs.length) return "—";
    return rrrs.map(r=>{
      const p=r.properties||r;
      const bits=[safe(p.type,"RRR"), p.status||"", p.holder||p.purpose||p.note||""].filter(Boolean);
      return chip(bits.join(" • "));
    }).join("");
  }
  function renderPlans(plans=[]){
    if(!plans.length) return "—";
    return plans.map(sp=>{
      const p=sp.properties||sp;
      return chip(`${safe(p.planId,"Plan")} — ${safe(p.description,"")}`);
    }).join("");
  }
  function renderAssess(ass=[]){
    if(!ass.length) return "—";
    return ass.map(a=>{
      const p=a.properties||a;
      return chip(`${safe(p.year,"Year")} — ${money(p.value)}`);
    }).join("");
  }
  function renderZoning(zs=[]){
    if(!zs.length) return "—";
    return zs.map(z=>{
      const p=z.properties||z;
      return chip(safe(p.zoneType,"Zoning"));
    }).join("");
  }

  function renderParcelView(view){
    // normalize (API vs local)
    const parcel   = view.parcel?.properties ? view.parcel.properties : (view.parcel||view);
    const titles   = view.titles || (view.title ? [view.title] : []);
    const owners   = view.owners || [];
    const rrrs     = view.rrrs || [];
    const plans    = view.plans || (view.surveyPlan ? [view.surveyPlan] : []);
    const assess   = view.assessments || (view.assessment ? [view.assessment] : []);
    const zonings  = view.zonings || (view.zoning ? [view.zoning] : []);

    const pid   = safe(parcel?.parcelId,"Unknown");
    const legal = safe(parcel?.legalDescription,"—");

    const titleBadges = titles.length
      ? titles.map(t=>{
          const p=t.properties||t;
          return chip(`${safe(p.titleId,"Title")} — ${safe(p.status,"")}`);
        }).join("")
      : "—";

    return `
      <div style="min-width:280px;max-width:380px">
        <div style="font-weight:800;font-size:16px">Parcel ${pid}</div>
        <div style="color:#555;margin:2px 0 8px">${legal}</div>

        <div style="margin:8px 0">
          <div style="font-weight:700;margin-bottom:4px">Title</div>
          <div>${titleBadges}</div>
        </div>

        <div style="margin:8px 0">
          <div style="font-weight:700;margin-bottom:4px">Owner(s)</div>
          <ul style="margin:0;padding-left:18px">${renderOwners(owners)}</ul>
        </div>

        <div style="margin:8px 0">
          <div style="font-weight:700;margin-bottom:4px">RRR</div>
          <div>${renderRRR(rrrs)}</div>
        </div>

        <div style="margin:8px 0">
          <div style="font-weight:700;margin-bottom:4px">Zoning</div>
          <div>${renderZoning(zonings)}</div>
        </div>

        <div style="margin:8px 0">
          <div style="font-weight:700;margin-bottom:4px">Survey Plan</div>
          <div>${renderPlans(plans)}</div>
        </div>

        <div style="margin:8px 0">
          <div style="font-weight:700;margin-bottom:4px">Assessment</div>
          <div>${renderAssess(assess)}</div>
        </div>

        <div style="margin-top:10px;font-size:12px;opacity:.7">
          Source: ${window.API_BASE ? "Live API" : "Local JSON"}
        </div>
      </div>`;
  }

  // =========================================================
  // 3) Map + polygons + dropdown
  // =========================================================
  const map = L.map('map', { center:[49.25,-123.12], zoom: 12 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const byParcelId = new Map();
  const $select = document.getElementById('parcelSelect');
  let geoLayer;
  let highlighted;

  function highlight(layer){
    if (highlighted) highlighted.setStyle({ color:"#1f78b4", weight:2, fillOpacity:.15 });
    highlighted = layer;
    layer.setStyle({ color:"#d81b60", weight:3, fillOpacity:.25 });
  }

  function addParcelsLayer(){
    geoLayer = L.geoJSON(window.PARCELS_GEOJSON, {
      style: { color: "#1f78b4", weight: 2, fillOpacity: .15 },
      onEachFeature: (feature, layer) => {
        const pid = feature?.properties?.parcelId;
        if (pid) byParcelId.set(pid, layer);

        layer.on('click', () => {
          highlight(layer);
          openParcel(pid, layer);
        });
      }
    }).addTo(map);

    const b = geoLayer.getBounds();
    if (b.isValid()) map.fitBounds(b.pad(0.2));
  }

  async function openParcel(parcelId, layer){
    try{
      let data;
      if (window.API_BASE){
        const res = await fetch(`${window.API_BASE}/api/v1/parcels/${encodeURIComponent(parcelId)}`);
        if (!res.ok) throw new Error(`API ${res.status}`);
        data = await res.json();
      } else {
        const res = await fetch('parcel_views.json');
        if (!res.ok) throw new Error(`parcel_views.json ${res.status}`);
        const views = await res.json();
        data = views[parcelId];
        if (!data) throw new Error(`parcel ${parcelId} not found in parcel_views.json`);
      }

      layer.bindPopup(renderParcelView(data), { maxWidth: 420 }).openPopup();

    }catch(err){
      console.error(err);
      layer.bindPopup(`<b>Could not load parcel ${parcelId}</b><br/><small>${String(err.message||err)}</small>`).openPopup();
    }
  }

  async function populateDropdown(){
    if (window.API_BASE){
      try{
        const res = await fetch(`${window.API_BASE}/api/v1/parcels?limit=500&props=1`);
        const data = await res.json();
        (data.items||[]).forEach(row=>{
          const opt = document.createElement('option');
          opt.value = row.parcelId;
          opt.textContent = row.legalDescription ? `${row.parcelId} — ${row.legalDescription}` : row.parcelId;
          $select.appendChild(opt);
        });
      }catch(e){
        await populateFromLocal();
      }
    } else {
      await populateFromLocal();
    }

    $select.addEventListener('change', ()=>{
      const pid = $select.value;
      if (!pid) return;
      const lyr = byParcelId.get(pid);
      if (lyr){
        const b = lyr.getBounds?.();
        if (b?.isValid()) map.fitBounds(b.pad(0.3));
        highlight(lyr);
        openParcel(pid, lyr);
        loadParcelGraph(pid); // keep graph in sync
      } else {
        alert(`Parcel ${pid} not found in the map layer.`);
      }
    });
  }

  async function populateFromLocal(){
    try{
      const res = await fetch('parcel_views.json');
      const views = await res.json();
      Object.keys(views).sort().forEach(pid=>{
        const opt = document.createElement('option');
        const desc = views[pid]?.legalDescription || "";
        opt.value = pid;
        opt.textContent = desc ? `${pid} — ${desc}` : pid;
        $select.appendChild(opt);
      });
    }catch(e){
      console.warn("Could not load parcel_views.json for dropdown:", e);
    }
  }

  // =========================================================
  // 4) Embedded Neo4j graph (Cytoscape) — API mode
  // =========================================================
  let cy;
  function initGraph() {
    cy = cytoscape({
      container: document.getElementById('graph'),
      elements: [],
      style: [
        { selector: 'node',
          style: {
            'label': 'data(label)',
            'text-valign': 'center',
            'color': '#1b1f24',
            'font-size': 10,
            'background-color': '#F5F7FA',
            'border-width': 2,
            'border-color': '#9AA1AC'
          }
        },
        { selector: 'node[labelType = "Parcel"]',
          style: { 'background-color': '#ff6b6b', 'border-color': '#e35151' }
        },
        { selector: 'node[labelType = "Title"]',
          style: { 'background-color': '#51cf66', 'border-color': '#37b24d' }
        },
        { selector: 'node[labelType = "Owner"]',
          style: { 'background-color': '#4dabf7', 'border-color': '#228be6' }
        },
        { selector: 'node[labelType = "RRR"]',
          style: { 'background-color': '#ffa94d', 'border-color': '#f08c00' }
        },
        { selector: 'node[labelType = "SurveyPlan"]',
          style: { 'background-color': '#b197fc', 'border-color': '#845ef7' }
        },
        { selector: 'node[labelType = "Assessment"]',
          style: { 'background-color': '#63e6be', 'border-color': '#20c997' }
        },
        { selector: 'node[labelType = "Zoning"]',
          style: { 'background-color': '#ffd43b', 'border-color': '#f59f00' }
        },
        { selector: 'edge',
          style: {
            'label': 'data(type)',
            'width': 2,
            'line-color': '#B7BEC9',
            'target-arrow-color': '#B7BEC9',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'font-size': 8
          }
        }
      ],
      layout: { name: 'concentric', minNodeSpacing: 40 }
    });
  }

  async function loadParcelGraph(parcelId) {
    if (!window.API_BASE) return; // graph only in API mode
    try {
      const res = await fetch(`${window.API_BASE}/api/v1/graph/parcel/${encodeURIComponent(parcelId)}`);
      const g = await res.json();

      const nodes = (g.nodes || []).map(n => {
        const labelType = (n.labels && n.labels[0]) || 'Node';
        const label =
          labelType === 'Parcel'     ? (n.props.parcelId || 'Parcel') :
          labelType === 'Title'      ? (n.props.titleId  || 'Title')  :
          labelType === 'Owner'      ? (n.props.name     || 'Owner')  :
          labelType === 'RRR'        ? (n.props.type     || 'RRR')    :
          labelType === 'SurveyPlan' ? (n.props.planId   || 'Plan')   :
          labelType === 'Assessment' ? (String(n.props.year || n.props.assessmentId || 'Assess')) :
          labelType === 'Zoning'     ? (n.props.zoneType || n.props.zoneId || 'Zoning') :
          labelType;
        return { data: { id: n.id, label, labelType } };
      });

      const edges = (g.links || []).map(e => ({
        data: { id: e.id, source: e.source, target: e.target, type: e.type }
      }));

      cy.elements().remove();
      cy.add([...nodes, ...edges]);
      cy.layout({ name: 'concentric', minNodeSpacing: 40 }).run();
      cy.fit(undefined, 30);
    } catch (e) {
      console.warn("Graph load failed:", e);
    }
  }

  // Re-wrap openParcel to also refresh the graph
  const _openParcelOrig = openParcel;
  openParcel = async function(pid, layer) {
    await _openParcelOrig(pid, layer);
    loadParcelGraph(pid);
  };

  // Boot
  addParcelsLayer();
  populateDropdown();
  initGraph();
  </script>
</body>
</html>
