<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Parcel Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header { padding:10px 14px; border-bottom:1px solid #e5e7eb; display:flex; gap:10px; align-items:center; }
    #app { display:grid; grid-template-columns: 1fr 340px; grid-template-rows: auto 1fr 280px; height: calc(100vh - 50px); }
    #toolbar { grid-column: 1 / span 2; display:flex; gap:8px; align-items:center; padding:10px 14px; border-bottom:1px solid #e5e7eb; }
    #map { grid-column: 1; grid-row: 2; }
    #panel { grid-column: 2; grid-row: 2 / span 2; border-left:1px solid #e5e7eb; overflow:auto; padding:12px; }
    #graph { grid-column: 1; grid-row: 3; border-top:1px solid #e5e7eb; }
    .lbl { font-size:12px; color:#6b7280; }
    .val { font-weight:600; }
    .row { display:grid; grid-template-columns: 110px 1fr; gap:6px; margin:6px 0; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>
  <header>
    <strong>Parcel Demo</strong>
    <span class="muted">Leaflet · Neo4j · Cytoscape</span>
  </header>

  <div id="app">
    <div id="toolbar">
      <label class="lbl" for="parcelSelect">Parcel</label>
      <select id="parcelSelect"><option value="">Loading parcels…</option></select>
    </div>

    <div id="map"></div>

    <aside id="panel">
      <h3>Parcel Details</h3>
      <div class="row"><div class="lbl">Parcel ID</div><div id="p-id" class="val">—</div></div>
      <div class="row"><div class="lbl">Legal</div><div id="p-legal">—</div></div>
      <div class="row"><div class="lbl">Title</div><div id="p-title">—</div></div>
      <div class="row"><div class="lbl">Owners</div><div id="p-owners">—</div></div>
      <div class="row"><div class="lbl">RRRs</div><div id="p-rrr">—</div></div>
      <div class="row"><div class="lbl">Zoning</div><div id="p-zoning">—</div></div>
      <div class="row"><div class="lbl">Plan</div><div id="p-plan">—</div></div>
      <div class="row"><div class="lbl">Assessment</div><div id="p-assess">—</div></div>
    </aside>

    <div id="graph"></div>
  </div>

  <script src="config.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.umd.js"></script>

  <script>
    const map = L.map('map').setView([49.25, -123.12], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OSM' }).addTo(map);

    const parcelSelect = document.getElementById("parcelSelect");

    function setText(id, text){
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = (text && String(text).trim()) || '—';
    }

    function firstOrNull(arr){ return Array.isArray(arr) && arr.length ? arr[0] : null; }
    function prop(o, k){
      if (!o) return null;
      const nested = o.properties && (o.properties[k] ?? o.properties[k?.toLowerCase?.()]);
      return nested !== undefined ? nested : o[k];
    }
    function pickAny(o, keys){
      for (const k of keys){
        const v = prop(o, k);
        if (v !== undefined && v !== null && v !== '') return v;
      }
      return null;
    }

    function loadDetails(id){
      if (typeof USING_API !== 'undefined' && USING_API){
        fetch(`${API_BASE}/api/v1/parcels/${encodeURIComponent(id)}`)
          .then(r => {
            if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
            return r.json();
          })
          .then(d => {
            const parcelNode = d.parcel || null;

            const pid = pickAny(parcelNode, ['parcelId','id']) || d.parcelId || id;
            setText('p-id', pid);

            const legal = pickAny(parcelNode, ['legalDescription','legal','legaldescription']);
            setText('p-legal', legal);

            const titleNode = firstOrNull(d.titles);
            const titleTxt = pickAny(titleNode, ['number','id','name','titleId']);
            setText('p-title', titleTxt);

            const owners = (d.owners || []).map(o => pickAny(o, ['name','ownerName'])).filter(Boolean).join(', ');
            setText('p-owners', owners);

            const rrrs = (d.rrrs || []).map(r => pickAny(r, ['type','rrrType','name'])).filter(Boolean).join(', ');
            setText('p-rrr', rrrs);

            const zoningList = Array.isArray(d.zonings) ? d.zonings : (d.zoning ? [d.zoning] : []);
            const zonings = zoningList.map(z => pickAny(z, ['code','name','zoningCode','zoning'])).filter(Boolean).join(', ');
            setText('p-zoning', zonings);

            const planNode = firstOrNull(d.plans);
            const planTxt = pickAny(planNode, ['number','name','id','planId']);
            setText('p-plan', planTxt);

            const assessNode = firstOrNull(d.assessments);
            const assessTxt = pickAny(assessNode, ['value','amount','year','id']);
            setText('p-assess', assessTxt);

            if (typeof renderGraph === 'function') renderGraph(id);
          })
          .catch(err => {
            console.error('Details load failed:', err);
            setText('p-id', id);
          });
      } else {
        setText('p-id', id);
      }
    }

    function renderGraph(id){
      fetch(`${API_BASE}/api/v1/graph/parcel/${encodeURIComponent(id)}`)
        .then(r => r.json())
        .then(g => {
          const nodes = g.nodes.map(n => ({ data: { id: n.id, label: n.label || n.id } }));
          const edges = g.edges.map(e => ({ data: { id: `${e.source}-${e.type}-${e.target}`, source: e.source, target: e.target, label: e.type } }));

          const cy = cytoscape({
            container: document.getElementById('graph'),
            elements: { nodes, edges },
            layout: { name: 'cose', animate: false },
            style: [
              { selector: 'node', style: { 'label':'data(label)', 'background-color':'#60a5fa', 'shape':'round-rectangle', 'text-valign':'center', 'text-wrap':'wrap' } },
              { selector: 'edge', style: { 'label':'data(label)', 'curve-style':'bezier', 'target-arrow-shape':'triangle', 'width':1 } },
            ]
          });
        });
    }

    fetch(GEOJSON_URL).then(r => r.json()).then(gj => {
      const geoLayer = L.geoJSON(gj, {
        style: { color:'#2563eb', weight:1, fillOpacity:0.2 },
        onEachFeature: (f, layer) => {
          const pid = f.properties.parcelid || f.properties.parcelId || f.properties.id;
          layer.on('click', () => { parcelSelect.value = pid; loadDetails(pid); });
        }
      }).addTo(map);
      map.fitBounds(geoLayer.getBounds());

      const options = gj.features.map(feat => feat.properties.parcelid || feat.properties.parcelId || feat.properties.id).filter(Boolean).sort();
      parcelSelect.innerHTML = `<option value="">Select a parcel…</option>` + options.map(o=>`<option value="${o}">${o}</option>`).join("");
    });

    parcelSelect.addEventListener("change", e => loadDetails(e.target.value));
  </script>
</body>
</html>
