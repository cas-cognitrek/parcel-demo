<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Demo — Map + Parcel Details + Graph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- Cytoscape for mini-graph -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <!-- Basic page styles -->
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111731;
      --muted: #96A4B3;
      --text: #EAF1F8;
      --accent: #6C8AE4;
      --accent-2: #EF476F;
      --border: #1d2642;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    header {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      border-bottom: 1px solid var(--border); background: #0d1430;
      position: sticky; top: 0; z-index: 10;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: #0f1a42; border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 10px; font-size: 12px; color: var(--muted);
    }
    .row {
      display: grid; grid-template-columns: 1.4fr 1fr; gap: 12px;
      padding: 12px; height: calc(100dvh - 64px);
    }
    .card {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;
    }
    .card header {
      background: #121a36; border-bottom: 1px solid var(--border);
      padding: 10px 12px; font-size: 14px; font-weight: 600;
    }
    .card .content { padding: 10px 12px; overflow: auto; flex: 1; }
    #map { width: 100%; height: 100%; }
    #controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    select, button {
      background: #0f1a42; color: var(--text);
      border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px;
    }
    select:focus, button:focus { outline: 1px solid var(--accent); }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .section { border: 1px dashed var(--border); border-radius: 10px; padding: 8px; }
    .section h4 { margin: 0 0 6px; font-size: 12px; color: var(--muted); letter-spacing: .04em; text-transform: uppercase; }
    .kv { font-size: 14px; line-height: 1.3; }
    .kv b { color: var(--accent); }
    #graphPanel { width: 100%; height: 280px; background: #0f1531; border: 1px solid var(--border); border-radius: 10px; }
    .hint { color: var(--muted); font-size: 12px; }
    @media (max-width: 1100px) {
      .row { grid-template-columns: 1fr; height: auto; }
      #graphPanel { height: 240px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Parcel Demo</h1>
    <span class="badge">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="#6C8AE4" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="#1d2642" stroke-width="2"/>
        <circle cx="12" cy="12" r="6" fill="#6C8AE4"/>
      </svg>
      <span id="sourceBadge">Initializing…</span>
    </span>
  </header>

  <div class="row">
    <!-- Map column -->
    <div class="card">
      <header>
        <div id="controls">
          <label for="parcelSelect" class="hint">Parcel</label>
          <select id="parcelSelect"><option value="">— choose —</option></select>
          <button id="btnFit">Fit</button>
        </div>
      </header>
      <div class="content">
        <div id="map"></div>
      </div>
    </div>

    <!-- Details + graph column -->
    <div class="card">
      <header>Parcel Details</header>
      <div class="content">
        <div class="grid2">
          <div class="section">
            <h4>Summary</h4>
            <div id="parcelPanel" class="kv">Select a parcel on the map or use the dropdown.</div>
          </div>
          <div class="section">
            <h4>Related Graph</h4>
            <div id="graphPanel"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Config must define window.API_BASE -->
  <script src="config.js"></script>

  <script>
  // ================== Map + Data Boot ==================
  const API_BASE = (window.API_BASE || "").trim();
  const USING_API = !!API_BASE;
  const $select = document.getElementById("parcelSelect");
  const $parcelPanel = document.getElementById("parcelPanel");
  const $graphHost = document.getElementById("graphPanel");
  const $badge = document.getElementById("sourceBadge");
  const $btnFit = document.getElementById("btnFit");

  // Set badge
  $badge.textContent = USING_API ? "Live API" : "Local JSON";

  // Leaflet map
  const map = L.map('map', { zoomControl: true });
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // Start centered over BC
  map.setView([49.25, -123.12], 11);

  let parcelsLayer = L.geoJSON(null, {
    onEachFeature: (feature, layer) => {
      layer.on('click', () => {
        const id = feature.properties?.parcelId || feature.properties?.id;
        if (id) selectParcel(id, true);
      });
    },
    style: {
      color: '#6C8AE4', weight: 2, fillColor: '#6C8AE4', fillOpacity: 0.15
    }
  }).addTo(map);

  // Fit button
  $btnFit.addEventListener('click', () => {
    try { map.fitBounds(parcelsLayer.getBounds(), { padding: [20,20] }); } catch(e) {}
  });

  // Load base data (either from API or from local files)
  async function boot() {
    if (USING_API) {
      await loadParcelsFromAPI();
      await loadGeojsonLocal(); // still draw local polygons unless later served by API
    } else {
      await loadParcelsFromLocalViews();
      await loadGeojsonLocal();
    }
  }

  // Populate dropdown using API
  async function loadParcelsFromAPI() {
    try {
      const res = await fetch(`${API_BASE}/api/v1/parcels?_=${Date.now()}`, { cache: 'no-store' });
      const data = await res.json();
      const ids = (data.parcels || []);
      fillDropdown(ids);
    } catch (e) {
      console.error('Failed to load parcels from API', e);
    }
  }

  // Populate dropdown using parcel_views.json
  async function loadParcelsFromLocalViews() {
    try {
      const res = await fetch('parcel_views.json', { cache: 'no-store' });
      const data = await res.json();
      const ids = Object.keys(data || {});
      fillDropdown(ids);
    } catch (e) {
      console.error('Failed to load parcels from parcel_views.json', e);
    }
  }

  function fillDropdown(ids) {
    $select.innerHTML = '<option value="">— choose —</option>';
    ids.sort().forEach(id => {
      const opt = document.createElement('option');
      opt.value = id; opt.textContent = id;
      $select.appendChild(opt);
    });
  }

  // Load polygons (local geojson)
  async function loadGeojsonLocal() {
    try {
      const res = await fetch('synthetic_parcels.geojson', { cache: 'no-store' });
      const gj = await res.json();
      parcelsLayer.clearLayers();
      parcelsLayer.addData(gj);
      map.fitBounds(parcelsLayer.getBounds(), { padding: [20,20] });
    } catch (e) {
      console.error('Failed to load synthetic_parcels.geojson', e);
    }
  }

  // Dropdown change
  $select.addEventListener('change', ev => {
    const id = ev.target.value;
    if (id) selectParcel(id, false);
  });

  // Select from dropdown or map click
  async function selectParcel(id, fromMap) {
    // Reflect in dropdown if came from map
    if (fromMap) {
      for (const opt of $select.options) {
        if (opt.value === id) { $select.value = id; break; }
      }
    }
    // Highlight on map
    highlightParcelOnMap(id);

    // Load details + graph
    await loadParcelDetails(id);
    await loadParcelGraph(id);
  }

  function highlightParcelOnMap(id) {
    parcelsLayer.eachLayer(layer => {
      const fid = layer.feature?.properties?.parcelId || layer.feature?.properties?.id;
      if (!fid) return;
      const isHit = (String(fid) === String(id));
      layer.setStyle({
        color: isHit ? '#EF476F' : '#6C8AE4',
        weight: isHit ? 3 : 2,
        fillOpacity: isHit ? 0.25 : 0.15
      });
      if (isHit && layer.getBounds) {
        map.fitBounds(layer.getBounds(), { padding: [30,30] });
      }
    });
  }

  // ============ Details loader ============
  async function loadParcelDetails(id) {
    if (!id) return;
    try {
      if (USING_API) {
        const url = `${API_BASE}/api/v1/parcels/${encodeURIComponent(id)}?_=${Date.now()}`;
        const d = await (await fetch(url, { cache: 'no-store' })).json();
        renderDetails(d);
      } else {
        // local JSON
        const views = await (await fetch('parcel_views.json', { cache: 'no-store' })).json();
        const d = views[id] || {};
        renderLocalDetails(id, d);
      }
      $badge.textContent = USING_API ? 'Live API' : 'Local JSON';
    } catch (e) {
      console.error('Parcel details error', e);
      $parcelPanel.innerHTML = '<em class="hint">Failed to load parcel details.</em>';
    }
  }

  function renderDetails(d) {
    const p = d.parcel?.properties || {};
    const titles = (d.titles || []).map(x => x.properties?.titleId || x.properties?.id || x.id).filter(Boolean);
    const owners = (d.owners || []).map(x => x.properties?.name || x.properties?.id || x.id).filter(Boolean);
    const rrrs   = (d.rrrs || []).map(x => x.properties?.type || x.properties?.kind || x.properties?.name || x.id).filter(Boolean);
    const zones  = (d.zoning || d.zonings || []).map(x => x.properties?.zoneId || x.properties?.zoningId || x.properties?.name || x.id).filter(Boolean);
    const plans  = (d.plans || []).map(x => x.properties?.planId || x.properties?.name || x.id).filter(Boolean);
    const assess = (d.assessments || []).map(x => x.properties?.assessmentId || x.properties?.id || x.id).filter(Boolean);

    $parcelPanel.innerHTML = `
      <div class="kv"><b>Parcel:</b> ${p.parcelId || '—'}</div>
      <div class="kv"><b>Legal:</b> ${p.legalDescription || '—'}</div>
      <hr/>
      <div class="kv"><b>Title</b><br/>${titles.join('<br/>') || '—'}</div>
      <div class="kv"><b>Owner(s)</b><br/>${owners.join('<br/>') || '—'}</div>
      <div class="kv"><b>RRR</b><br/>${rrrs.join('<br/>') || '—'}</div>
      <div class="kv"><b>Zoning</b><br/>${zones.join('<br/>') || '—'}</div>
      <div class="kv"><b>Survey Plan</b><br/>${plans.join('<br/>') || '—'}</div>
      <div class="kv"><b>Assessment</b><br/>${assess.join('<br/>') || '—'}</div>
    `;
  }

  function renderLocalDetails(id, dv) {
    // Minimal mapping for local JSON shape; adjust if your parcel_views.json differs
    $parcelPanel.innerHTML = `
      <div class="kv"><b>Parcel:</b> ${id}</div>
      <div class="kv"><b>Title:</b> ${dv.titleId || '—'}</div>
      <div class="kv"><b>Owner(s):</b> ${(dv.owners || []).join(', ') || '—'}</div>
      <div class="kv"><b>RRR:</b> ${(dv.rrr || []).join(', ') || '—'}</div>
      <div class="kv"><b>Zoning:</b> ${dv.zoning || '—'}</div>
      <div class="kv"><b>Survey Plan:</b> ${dv.planId || '—'}</div>
      <div class="kv"><b>Assessment:</b> ${dv.assessmentId || '—'}</div>
    `;
  }

  // ============ Graph loader (Cytoscape) ============
  let cy = null;
  function ensureCy() {
    if (cy) return cy;
    if (!$graphHost) return null;
    cy = cytoscape({
      container: $graphHost,
      style: [
        { selector: 'node[kind="Parcel"]', style: { 'background-color': '#ef476f', 'label': 'data(title)', 'font-size': 11, 'text-wrap': 'wrap', 'text-max-width': 120 } },
        { selector: 'node[kind="Owner"]',  style: { 'background-color': '#80ed99', 'label': 'data(title)' } },
        { selector: 'node[kind="Title"]',  style: { 'background-color': '#2ec4b6', 'label': 'data(title)' } },
        { selector: 'node[kind="RRR"]',    style: { 'background-color': '#ffd166', 'label': 'data(title)' } },
        { selector: 'node[kind="Zoning"]', style: { 'background-color': '#f4a261', 'label': 'data(title)' } },
        { selector: 'node[kind="Assessment"]', style: { 'background-color': '#6c8ae4', 'label': 'data(title)' } },
        { selector: 'node[kind="SurveyPlan"]', style: { 'background-color': '#90caf9', 'label': 'data(title)' } },
        { selector: 'node', style: { 'background-color': '#6c8ae4', 'label': 'data(title)', 'font-size': 10 } },
        { selector: 'edge', style: { 'width': 2, 'line-color': '#b8b8b8', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#b8b8b8', 'curve-style': 'bezier', 'label': 'data(type)', 'font-size': 8 } }
      ]
    });
    // Expose globally so other scripts/patches can access the instance
    window.cy = cy;
    return cy;
  }

  async function loadParcelGraph(id) {
    const c = ensureCy();
    if (!c || !id) return;
    // If local mode, we can skip the graph or synthesize a trivial one
    if (!USING_API) {
      c.elements().remove();
      return;
    }
    try {
      const url = `${API_BASE}/api/v1/graph/parcel/${encodeURIComponent(id)}?_=${Date.now()}`;
      const g = await (await fetch(url, { cache: 'no-store' })).json();
      const nodes = (g.nodes || []).map(n => ({
        group: 'nodes',
        data: {
          id: String(n.id),
          title: n.title ||
                 n.properties?.parcelId || n.properties?.name ||
                 n.properties?.titleId || n.properties?.planId ||
                 n.properties?.zoningId || n.properties?.assessmentId ||
                 n.id || 'Node',
          kind: n.kind || (Array.isArray(n.labels) ? n.labels[0] : 'Node')
        }
      }));
      const edges = (g.links || g.edges || []).map(e => ({
        group: 'edges',
        data: {
          id: e.id ? String(e.id) : `${e.source ?? e.start}->${e.target ?? e.end}:${e.type || ''}`,
          source: String(e.source ?? e.start),
          target: String(e.target ?? e.end),
          type: e.type || ''
        }
      }));
      c.elements().remove();
      c.add(nodes);
      c.add(edges);
      c.layout({ name: 'cose', animate: true }).run();
      if (c.elements().length) c.fit(c.elements(), 30);
    } catch (e) {
      console.error('Graph load error', e);
      c.elements().remove();
    }
  }

  // Boot
  window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
