<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Cytoscape for graph -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>

  <!-- Config: defines window.API_BASE -->
  <script src="./config.js"></script>

  <style>
    :root{
      --border:#d1d5db;
      --panel-bg:#fff;
      --text:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:var(--text); background:#f9fafb;
    }

    /* Layout: top controls + 3 panes */
    .topbar{
      position:fixed; z-index:1000; top:8px; left:8px; display:flex; gap:10px; align-items:center;
      background:#fff; border:1px solid var(--border); border-radius:8px; padding:6px 10px;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    .select{
      padding:6px 8px; border:1px solid var(--border); border-radius:6px; background:#fff;
    }
    .badge{
      padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f3f4f6;
      font-size:12px; color:#374151; cursor:pointer; user-select:none;
    }

    .wrap{
      display:grid;
      grid-template-columns: 1fr 380px;     /* map/graph | parcel panel */
      grid-template-rows: 58vh 1fr;         /* map row | graph row */
      gap:0;
      height:100vh;
    }
    #map{
      grid-column:1; grid-row:1;
      border-right:2px solid var(--border);
      border-bottom:2px solid var(--border);
    }
    #graph{
      grid-column:1; grid-row:2;
      border-right:2px solid var(--border);
    }
    .panel{
      grid-column:2; grid-row:1 / span 2;
      background:var(--panel-bg);
      border-left:2px solid var(--border);
      padding:14px 16px 24px 16px;
      overflow:auto;
    }
    .h6{ margin:0 0 10px 0; font-weight:700; font-size:18px; }
    .kv{ margin:12px 0; }
    .k{ font-weight:600; }
    .muted{ color:var(--muted); }

    /* Legend */
    .legend{ display:flex; gap:14px; flex-wrap:wrap; margin-top:12px; font-size:12px;}
    .dot{ display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:6px; vertical-align:middle;}

    /* Leaflet popup width fix on large screens */
    .leaflet-popup-content{ min-width:280px; }

  </style>
</head>
<body>

  <div class="topbar">
    <div>Jump to parcel:</div>
    <select id="jump" class="select">
      <option value="">— choose —</option>
    </select>
    <div id="modeBadge" class="badge" title="Toggle between Local JSON and Live API"></div>
  </div>

  <div class="wrap">
    <div id="map"></div>
    <div id="graph"></div>

    <aside class="panel">
      <div class="h6">Parcel</div>
      <div class="kv"><span class="muted">Source: </span><span id="panel-source">—</span></div>
      <div class="kv"><div class="k">Parcel:</div><div id="panel-parcel">—</div></div>
      <div class="kv"><div class="k">Legal:</div><div id="panel-legal" class="muted">(no details)</div></div>

      <div class="kv"><div class="k">Title</div><div id="panel-title">—</div></div>
      <div class="kv"><div class="k">Owner(s)</div><div id="panel-owners">—</div></div>
      <div class="kv"><div class="k">RRR</div><div id="panel-rrr">—</div></div>
      <div class="kv"><div class="k">Zoning</div><div id="panel-zoning">—</div></div>
      <div class="kv"><div class="k">Survey Plan</div><div id="panel-plan">—</div></div>
      <div class="kv"><div class="k">Assessment</div><div id="panel-assess">—</div></div>

      <div class="legend">
        <span><span class="dot" style="background:#ef4444"></span>Parcel</span>
        <span><span class="dot" style="background:#60a5fa"></span>Plan</span>
        <span><span class="dot" style="background:#f59e0b"></span>Zoning</span>
        <span><span class="dot" style="background:#10b981"></span>Title</span>
        <span><span class="dot" style="background:#8b5cf6"></span>Owner</span>
        <span><span class="dot" style="background:#f97316"></span>RRR</span>
        <span><span class="dot" style="background:#3b82f6"></span>Assessment</span>
      </div>
    </aside>
  </div>

  <!-- Data files (used in Local JSON mode) -->
  <script>
    const COLORS = {
      Parcel: '#ef4444',
      Plan: '#60a5fa',
      Zoning:'#f59e0b',
      Title:'#10b981',
      Owner:'#8b5cf6',
      RRR:'#f97316',
      Assessment:'#3b82f6',
      Thing:'#9ca3af'
    };

    // runtime state
    let MODE = (window.API_BASE && window.API_BASE.trim()) ? 'API' : 'LOCAL';
    let MAP, PARCEL_LAYER, CY;
    let GEOJSON=null;           // synthetic_parcels.geojson
    let VIEWS_BY_ID={};         // parcel_views.json indexed
    let CURRENT_PARCEL_ID=null;

    // ---- boot
    document.addEventListener('DOMContentLoaded', async () => {
      setModeBadge();
      await loadLocalData();        // safe to run even if MODE==='API' (helps dropdown)
      initMap();
      initGraph();
      populateJump();

      document.getElementById('jump').addEventListener('change', e=>{
        if(e.target.value) onParcelChosen(e.target.value);
      });
      document.getElementById('modeBadge').addEventListener('click', () => {
        MODE = (MODE==='API') ? 'LOCAL' : 'API';
        setModeBadge();
        // keep current parcel shown if we have it
        if(CURRENT_PARCEL_ID) onParcelChosen(CURRENT_PARCEL_ID);
      });
    });

    function setModeBadge(){
      const b = document.getElementById('modeBadge');
      b.textContent = MODE==='API' ? 'Mode: Live API' : 'Mode: Local JSON';
    }

    // ---- data
    async function loadLocalData(){
      // Load synthetic files to ensure dropdown & local mode work even if API is selected
      try{
        const gj = await fetch('./synthetic_parcels.geojson').then(r=>r.json());
        GEOJSON = gj;
      }catch(e){ console.warn('GeoJSON not loaded (ok if API only).', e); }
      try{
        const pv = await fetch('./parcel_views.json').then(r=>r.json());
        VIEWS_BY_ID = {};
        pv.forEach(v => { if(v?.parcelId) VIEWS_BY_ID[v.parcelId] = v; });
      }catch(e){ console.warn('parcel_views not loaded (ok if API only).', e); }
    }

    // ---- map
    function initMap(){
      MAP = L.map('map', {
        zoomControl: true,
        scrollWheelZoom: true,
      }).setView([49.250, -123.120], 12);   // Vancouver area

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'&copy; OpenStreetMap',
        maxZoom: 19
      }).addTo(MAP);

      // draw polygons if we have local data
      if(GEOJSON){
        PARCEL_LAYER = L.geoJSON(GEOJSON, {
          style: { color:'#2563eb', weight:1.5, fillOpacity:0.15 },
          onEachFeature: (f, layer) => {
            const pid = f?.properties?.parcelid || f?.properties?.id;
            layer.on('click', () => {
              // no fitBounds (prevents auto-zoom), just show details
              onParcelChosen(pid);
            });
          }
        }).addTo(MAP);

        // Ensure parcels are visible at start
        try{ MAP.fitBounds(PARCEL_LAYER.getBounds(), { padding:[30,30] }); } catch{}
      }
    }

    // ---- graph
    function initGraph(){
      CY = cytoscape({
        container: document.getElementById('graph'),
        elements: [],
        style: [
          {
            selector:'node',
            style:{
              'label':'data(name)',
              'font-size':9,
              'text-valign':'center',
              'text-halign':'center',
              'color':'#111827',
              'background-color': ele => COLORS[ele.data('label')] || COLORS.Thing,
              'border-color':'#374151',
              'border-width':1,
              'width':6,
              'height':6
            }
          },
          {
            selector:'edge',
            style:{
              'width':1,
              'curve-style':'bezier',
              'line-color':'#9ca3af',
              'target-arrow-shape':'triangle',
              'target-arrow-color':'#9ca3af',
              'label':'data(type)',
              'font-size':9,
              'text-rotation':'autorotate',
              'text-margin-y':-2,
              'color':'#6b7280'
            }
          },
          { selector:'.center', style:{ 'width':10, 'height':10, 'border-width':2 } }
        ],
        layout:{ name:'cose', fit:true, animate:false }
      });
    }

    function drawGraph(data){
      // data: {nodes:[{id,name,label}], links:[{source,target,type}]}
      const eles = [];
      (data.nodes||[]).forEach(n=>{
        eles.push({ data:{ id:n.id, name:n.name||n.id, label:n.label||'Thing' }, classes:(n.id===CURRENT_PARCEL_ID?'center':'') });
      });
      (data.links||[]).forEach(e=>{
        if(e.source && e.target) eles.push({ data:{ id:`${e.source}->${e.target}-${e.type||''}-${Math.random()}`, source:e.source, target:e.target, type:e.type||'' }});
      });
      CY.elements().remove();
      CY.add(eles);
      CY.layout({ name:'cose', fit:true, animate:false }).run();
    }

    // ---- dropdown
    function populateJump(){
      const sel = document.getElementById('jump');
      // prefer GeoJSON properties for list; otherwise from parcel_views
      let ids = [];
      if(GEOJSON?.features){
        ids = GEOJSON.features.map(f => f?.properties?.parcelid || f?.properties?.id).filter(Boolean);
      }else{
        ids = Object.keys(VIEWS_BY_ID);
      }
      sel.innerHTML = '<option value="">— choose —</option>' + ids.map(id=>`<option value="${id}">${id}</option>`).join('');
    }

    // ---- selection
    async function onParcelChosen(parcelId){
      CURRENT_PARCEL_ID = parcelId;

      if(MODE==='API' && window.API_BASE){
        await showFromAPI(parcelId);
      }else{
        await showFromLocal(parcelId);
      }
    }

    // panel helpers
    function setPanel(source, view, parcelId){
      const g = (id, html) => document.getElementById(id).innerHTML = html || '—';
      g('panel-source', source);
      g('panel-parcel', parcelId || '—');

      // Legal (if present)
      g('panel-legal', view?.parcel?.properties?.legalDescription || '(no details)');

      // Title
      const titles = Array.isArray(view?.titles) ? view.titles : (view?.title ? [view.title] : []);
      g('panel-title', titles.length ? (titles[0].id || '—') : '—');

      // Owners
      const owners = titles.flatMap(t => Array.isArray(t.owners) ? t.owners : []);
      g('panel-owners', owners.length ? owners.map(o=>o.name).join(', ') : '—');

      // RRR
      const rrrs = Array.isArray(view?.rrrs) ? view.rrrs : [];
      g('panel-rrr', rrrs.length ? rrrs.map(r=>r.type || r.name).join(', ') : '—');

      // Zoning
      const zonings = Array.isArray(view?.zonings) ? view.zonings : [];
      g('panel-zoning', zonings.length ? zonings.map(z=>z.code || z.name).join(', ') : '—');

      // Survey Plan
      const plans = Array.isArray(view?.plans) ? view.plans : (view?.plan ? [view.plan] : []);
      g('panel-plan', plans.length ? plans.map(p=>p.number || p.name).join(', ') : '—');

      // Assessment
      const assess = view?.assessment || (Array.isArray(view?.assessments) ? view.assessments[0] : null);
      g('panel-assess', assess?.id || '—');
    }

    // graph build (generic)
    function graphFromView(view, parcelId){
      const nodes = [{ id:parcelId, name:parcelId, label:'Parcel' }];
      const links = [];
      const seen = new Set();
      const addNode = (id, name, label) => {
        if(!id || seen.has(id)) return;
        nodes.push({ id, name: name||id, label }); seen.add(id);
      };
      const addLink = (a,b,t) => { if(a&&b) links.push({ source:a, target:b, type:t }); };

      // Title + Owners
      const titles = Array.isArray(view?.titles) ? view.titles : (view?.title ? [view.title] : []);
      titles.forEach((t, i)=>{
        const tid = t.id || `Title_${i+1}`;
        addNode(tid, tid, 'Title');
        addLink(parcelId, tid, 'HAS_TITLE');

        (Array.isArray(t.owners)?t.owners:[]).forEach((o, j)=>{
          const oid = o.name || `Owner_${i+1}_${j+1}`;
          addNode(oid, oid, 'Owner');
          addLink(tid, oid, 'OWNED_BY');
        });
      });

      // Zoning
      (Array.isArray(view?.zonings) ? view.zonings : []).forEach((z, i)=>{
        const zid = z.code || z.name || `Z_${i+1}`;
        addNode(zid, zid, 'Zoning'); addLink(parcelId, zid, 'HAS_ZONING');
      });

      // Plans
      (Array.isArray(view?.plans)?view.plans:(view?.plan?[view.plan]:[])).forEach((p, i)=>{
        const pid = p.number || p.name || `P_${i+1}`;
        addNode(pid, pid, 'Plan'); addLink(parcelId, pid, 'HAS_PLAN');
      });

      // RRRs
      (Array.isArray(view?.rrrs) ? view.rrrs : []).forEach((r, i)=>{
        const rid = r.type || r.name || `RRR_${i+1}`;
        addNode(rid, rid, 'RRR'); addLink(parcelId, rid, 'HAS_RRR');
      });

      // Assessment
      const assess = view?.assessment || (Array.isArray(view?.assessments)?view.assessments[0]:null);
      if(assess?.id){ addNode(assess.id, assess.id, 'Assessment'); addLink(parcelId, assess.id, 'HAS_ASSESSMENT'); }
      return { nodes, links };
    }

    // ---- mode handlers
    async function showFromLocal(parcelId){
      const view = VIEWS_BY_ID[parcelId] || {
        parcel:{ properties:{ legalDescription:null } },
        titles:[], zonings:[], plans:[], rrrs:[], assessments:[]
      };
      setPanel('Local JSON', view, parcelId);
      drawGraph( graphFromView(view, parcelId) );
    }

    async function showFromAPI(parcelId){
      try{
        const [parcelView, graphResp] = await Promise.all([
          fetch(`${window.API_BASE}/api/v1/parcels/${encodeURIComponent(parcelId)}`).then(r=>r.json()),
          fetch(`${window.API_BASE}/api/v1/graph/parcel/${encodeURIComponent(parcelId)}`).then(r=>r.json()).catch(()=>null)
        ]);

        setPanel('Live API', parcelView, parcelId);

        // Prefer API graph if present; else derive from the view as a fallback
        if(graphResp && graphResp.nodes && graphResp.links){
          drawGraph(graphResp);
        }else{
          drawGraph( graphFromView(parcelView, parcelId) );
        }
      }catch(e){
        console.error('API error', e);
        setPanel('Live API (error)', {}, parcelId);
        drawGraph({nodes:[{id:parcelId,name:parcelId,label:'Parcel'}], links:[]});
      }
    }
  </script>
</body>
</html>
