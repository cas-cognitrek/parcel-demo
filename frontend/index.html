<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Demo — Map + Parcel Details + Graph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <!-- Cytoscape for mini-graph -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 6px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      font-family: sans-serif;
    }
    #details {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 40%;
      background: rgba(255,255,255,0.95);
      overflow: auto;
      border-top: 2px solid #ccc;
      padding: 10px;
      font-family: sans-serif;
    }
    #parcelPanel { margin-bottom: 12px; }
    #graphPanel { width: 100%; height: 240px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="controls">
    <label for="parcelSelect">Parcel:</label>
    <select id="parcelSelect"><option value="">— choose —</option></select>
    <button id="btnFit">Fit</button>
  </div>

  <div id="details">
    <div id="parcelPanel">Select a parcel to see details here.</div>
    <div id="graphPanel"></div>
  </div>

  <!-- Config must define window.API_BASE -->
  <script src="config.js"></script>

  <script>
  const API_BASE = (window.API_BASE || "").trim();
  const USING_API = !!API_BASE;
  const $select = document.getElementById("parcelSelect");
  const $parcelPanel = document.getElementById("parcelPanel");
  const $graphHost = document.getElementById("graphPanel");
  const $btnFit = document.getElementById("btnFit");

  const map = L.map('map');
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  map.setView([49.25, -123.12], 11);

  let parcelsLayer = L.geoJSON(null, {
    onEachFeature: (feature, layer) => {
      layer.on('click', () => {
        const id = feature.properties?.parcelId || feature.properties?.id;
        if (id) selectParcel(id, true);
      });
    },
    style: { color: '#3388ff', weight: 2, fillOpacity: 0.15 }
  }).addTo(map);

  $btnFit.addEventListener('click', () => {
    try { map.fitBounds(parcelsLayer.getBounds(), { padding: [20,20] }); } catch(e) {}
  });

  async function boot() {
    if (USING_API) {
      await loadParcelsFromAPI();
      await loadGeojsonLocal();
    } else {
      await loadParcelsFromLocalViews();
      await loadGeojsonLocal();
    }
  }

  async function loadParcelsFromAPI() {
    const res = await fetch(`${API_BASE}/api/v1/parcels?_=${Date.now()}`);
    const data = await res.json();
    fillDropdown(data.parcels || []);
  }
  async function loadParcelsFromLocalViews() {
    const res = await fetch('parcel_views.json');
    const data = await res.json();
    fillDropdown(Object.keys(data || {}));
  }
  function fillDropdown(ids) {
    $select.innerHTML = '<option value="">— choose —</option>';
    ids.sort().forEach(id => {
      const opt = document.createElement('option');
      opt.value = id; opt.textContent = id;
      $select.appendChild(opt);
    });
  }
  async function loadGeojsonLocal() {
    const res = await fetch('synthetic_parcels.geojson');
    const gj = await res.json();
    parcelsLayer.clearLayers();
    parcelsLayer.addData(gj);
    map.fitBounds(parcelsLayer.getBounds(), { padding: [20,20] });
  }

  $select.addEventListener('change', ev => selectParcel(ev.target.value, false));

  async function selectParcel(id, fromMap) {
    if (fromMap) $select.value = id;
    highlightParcel(id);
    await loadParcelDetails(id);
    await loadParcelGraph(id);
  }
  function highlightParcel(id) {
    parcelsLayer.eachLayer(layer => {
      const fid = layer.feature?.properties?.parcelId || layer.feature?.properties?.id;
      if (!fid) return;
      const isHit = String(fid) === String(id);
      layer.setStyle({ color: isHit ? '#EF476F' : '#3388ff', weight: isHit ? 3 : 2 });
    });
  }

  async function loadParcelDetails(id) {
    if (!id) return;
    if (USING_API) {
      const d = await (await fetch(`${API_BASE}/api/v1/parcels/${encodeURIComponent(id)}?_=${Date.now()}`)).json();
      renderDetails(d);
    } else {
      const views = await (await fetch('parcel_views.json')).json();
      renderLocalDetails(id, views[id] || {});
    }
  }
  function renderDetails(d) {
    const p = d.parcel?.properties || {};
    $parcelPanel.innerHTML = `
      <b>Parcel:</b> ${p.parcelId || '—'}<br/>
      <b>Legal:</b> ${p.legalDescription || '—'}<br/>
    `;
  }
  function renderLocalDetails(id, dv) {
    $parcelPanel.innerHTML = `<b>Parcel:</b> ${id}<br/>Title: ${dv.titleId || '—'}`;
  }

  let cy = null;
  function ensureCy() {
    if (cy) return cy;
    cy = cytoscape({ container: $graphHost, style: [
      { selector: 'node', style: { 'background-color': '#6c8ae4', 'label': 'data(title)', 'font-size': 10 } },
      { selector: 'edge', style: { 'width': 2, 'line-color': '#999', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#999', 'curve-style': 'bezier', 'label': 'data(type)', 'font-size': 8 } }
    ]});
    return cy;
  }

  async function loadParcelGraph(id) {
    const c = ensureCy();
    if (!id || !USING_API) { c.elements().remove(); return; }
    const g = await (await fetch(`${API_BASE}/api/v1/graph/parcel/${encodeURIComponent(id)}?_=${Date.now()}`)).json();
    const nodes = (g.nodes || []).map(n => ({ group: 'nodes', data: { id: String(n.id), title: n.properties?.parcelId || n.properties?.name || n.id } }));
    const edges = (g.links || []).map(e => ({ group: 'edges', data: { id: e.id || `${e.source}->${e.target}`, source: String(e.source), target: String(e.target), type: e.type || '' } }));
    c.elements().remove();
    c.add(nodes);
    c.add(edges);
    c.layout({ name: 'cose', animate: true }).run();
    if (c.elements().length) c.fit(c.elements(), 30);
  }

  window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
