<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Demo — Map + Parcel Details + Graph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- Cytoscape for mini-graph -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <!-- Basic page styles -->
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111731;
      --muted: #96A4B3;
      --text: #EAF1F8;
      --accent: #6C8AE4;
      --accent-2: #EF476F;
      --border: #1d2642;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    header {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      border-bottom: 1px solid var(--border); background: #0d1430;
      position: sticky; top: 0; z-index: 10;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: #0f1a42; border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 10px; font-size: 12px; color: var(--muted);
    }
    .row {
      display: grid; grid-template-columns: 1.4fr 1fr; gap: 12px;
      padding: 12px; height: calc(100dvh - 64px);
    }
    .card {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;
    }
    .card header {
      background: #121a36; border-bottom: 1px solid var(--border);
      padding: 10px 12px; font-size: 14px; font-weight: 600;
    }
    .card .content { padding: 10px 12px; overflow: auto; flex: 1; }
    #map { width: 100%; height: 100%; }
    #controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    select, button {
      background: #0f1a42; color: var(--text);
      border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px;
    }
    select:focus, button:focus { outline: 1px solid var(--accent); }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .section { border: 1px dashed var(--border); border-radius: 10px; padding: 8px; }
    .section h4 { margin: 0 0 6px; font-size: 12px; color: var(--muted); letter-spacing: .04em; text-transform: uppercase; }
    .kv { font-size: 14px; line-height: 1.3; }
    .kv b { color: var(--accent); }
    #graphPanel { width: 100%; height: 280px; background: #0f1531; border: 1px solid var(--border); border-radius: 10px; }
    .hint { color: var(--muted); font-size: 12px; }
    @media (max-width: 1100px) {
      .row { grid-template-columns: 1fr; height: auto; }
      #graphPanel { height: 240px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Parcel Demo</h1>
    <span class="badge">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="#6C8AE4" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="#1d2642" stroke-width="2"/>
        <circle cx="12" cy="12" r="6" fill="#6C8AE4"/>
      </svg>
      <span id="sourceBadge">Initializing…</span>
    </span>
  </header>

  <div class="row">
    <!-- Map column -->
    <div class="card">
      <header>
        <div id="controls">
          <label for="parcelSelect" class="hint">Parcel</label>
          <select id="parcelSelect"><option value="">— choose —</option></select>
          <button id="btnFit">Fit</button>
        </div>
      </header>
      <div class="content">
        <div id="map"></div>
      </div>
    </div>

    <!-- Details + graph column -->
    <div class="card">
      <header>Parcel Details</header>
      <div class="content">
        <div class="grid2">
          <div class="section">
            <h4>Summary</h4>
            <div id="parcelPanel" class="kv">Select a parcel on the map or use the dropdown.</div>
          </div>
          <div class="section">
            <h4>Related Graph</h4>
            <div id="graphPanel"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Config must define window.API_BASE -->
  <script src="config.js"></script>

  <!-- main logic unchanged -->
  … (map, details, ensureCy, loadParcelGraph etc.) …

  <!-- keep the bottom patch -->
<script>
// === Minimal graph refresh patch (no UI changes) ===
(function () {
  const API_BASE = (window.API_BASE || "").trim();
  const sel = document.getElementById("parcelSelect");

  function getCy() {
    return window.cy || window.CY || window.graphCy || null;
  }

  async function fetchJSON(url) {
    const sep = url.includes("?") ? "&" : "?";
    const res = await fetch(`${url}${sep}_=${Date.now()}`, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return res.json();
  }

  async function reloadGraphFor(id) {
    if (!id || !API_BASE) return;
    const cy = getCy();
    if (!cy) return;

    const url = `${API_BASE}/api/v1/graph/parcel/${encodeURIComponent(id)}`;
    try {
      const g = await fetchJSON(url);
      const nodes = (g.nodes || []).map(n => ({
        group: "nodes",
        data: {
          id: String(n.id),
          title: n.title ||
                 n.properties?.parcelId || n.properties?.name ||
                 n.properties?.titleId || n.properties?.planId ||
                 n.properties?.zoningId || n.properties?.assessmentId ||
                 n.id || "Node",
          kind: n.kind || (Array.isArray(n.labels) ? n.labels[0] : "Node")
        }
      }));
      const edges = (g.links || g.edges || []).map(e => ({
        group: "edges",
        data: {
          id: e.id ? String(e.id) : `${e.source ?? e.start}->${e.target ?? e.end}:${e.type || ""}`,
          source: String(e.source ?? e.start),
          target: String(e.target ?? e.end),
          type: e.type || ""
        }
      }));
      cy.elements().remove();
      cy.add(nodes);
      cy.add(edges);
      cy.layout({ name: "cose", animate: true }).run();
      if (cy.elements().length) cy.fit(cy.elements(), 30);
    } catch (err) {
      console.error("Graph reload error", err);
      const cy = getCy();
      if (cy) cy.elements().remove();
    }
  }

  if (sel) {
    sel.addEventListener("change", (ev) => reloadGraphFor(ev.target.value), { passive: true });
    if (sel.value) reloadGraphFor(sel.value);
  }
  window.reloadParcelGraph = reloadGraphFor;
})();
</script>
</body>
</html>
